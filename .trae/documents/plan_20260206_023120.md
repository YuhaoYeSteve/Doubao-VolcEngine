# 联网搜索功能开发设计文档

根据火山引擎官方文档（[联网内容插件](https://www.volcengine.com/docs/82379/1338552?lang=zh) 和 [联网搜索 Web Search](https://www.volcengine.com/docs/82379/1756990?lang=zh)），我们将在 `ark_server.py` 中集成原生联网搜索能力。

## 核心设计思路
利用 `volcenginesdkarkruntime` SDK 的 `tools` 参数，向模型传递 `web_search` 工具定义。这将允许模型根据用户问题自动决定是否进行联网搜索，并返回包含搜索结果的答案。

## 修改点详述：[ark_server.py](file:///Users/bytedance/Library/CloudStorage/坚果云-yeyuhaosteve@163.com/我的坚果云/AI coding/Trae/ark/ark_server.py)

### 1. 更新请求数据模型 (`ChatRequest`)
在 `ChatRequest` 类中新增 `web_search` 字段，允许前端显式控制是否开启联网功能。

```python
class ChatRequest(BaseModel):
    messages: List[ChatMessage]
    stream: Optional[bool] = False
    model: Optional[str] = None
    web_search: Optional[bool] = False  # 新增字段
```

### 2. 构建工具参数 (`chat` 函数)
在 `chat` 函数内部，根据请求中的 `web_search` 标志构建 `tools` 参数。

```python
# 在调用 SDK 之前构建 tools
tools = None
if req.web_search:
    tools = [{
        "type": "web_search",
        "web_search": {
            "enable": True  # 显式启用
        }
    }]
```
*注：根据文档，`web_search` 工具的定义方式可能需要根据 SDK 版本微调，标准格式为 `{"type": "web_search"}` 或带配置项。*

### 3. 更新 SDK 调用 (`client.chat.completions.create`)
将 `tools` 参数传递给 SDK 的创建方法。需要同时更新 **流式 (stream)** 和 **非流式** 两种调用路径。

**流式调用修改：**
```python
stream = client.chat.completions.create(
    model=model_id,
    messages=messages,
    stream=True,
    tools=tools  # 新增参数
)
```

**非流式调用修改：**
```python
resp = client.chat.completions.create(
    model=model_id,
    messages=messages,
    tools=tools  # 新增参数
)
```

## 验证计划
1.  **接口测试**：使用 `curl` 发送带有 `"web_search": true` 的 POST 请求，提问实时性问题（如“今天的新闻”）。
2.  **日志检查**：观察返回的流式数据中是否包含搜索过程或引用信息。

## 关联修改 (可选)
虽然本次仅关注后端，但建议后续在 `chat.html` 前端界面增加一个“联网搜索”开关，以便用户通过 UI 触发此功能。
